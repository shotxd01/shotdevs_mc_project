<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<main class="flex-1 p-6 md:p-8 overflow-y-auto h-screen">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 md:mb-8">
        <div>
            <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Your Bots</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-1 text-sm">Manage your Minecraft bot instances</p>
        </div>
        <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
        <button onclick="openCreateModal()" class="bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white px-4 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2 transition-all text-sm min-w-[160px] border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow">
            <span class="material-icons text-base">add</span> Create Bot
        </button>
        <% } %>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        <% bots.forEach(function(bot) { %>
            <div onclick="window.location.href='/bot/<%= bot.id %>'" class="bg-white dark:bg-slate-800/60 backdrop-blur-sm p-5 rounded-xl border border-slate-200 dark:border-slate-700/50 hover:border-slate-300 dark:hover:border-slate-600 cursor-pointer transition-all group">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-semibold truncate group-hover:text-slate-700 dark:group-hover:text-slate-200 transition-colors max-w-[70%]"><%= bot.name %></h3>
                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium <%= bot.online ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400' %>">
                        <%= bot.online ? 'ONLINE' : 'OFFLINE' %>
                    </span>
                </div>
                <div class="space-y-2 text-sm text-slate-500 dark:text-slate-400">
                    <p class="flex items-center gap-2.5">
                        <span class="material-icons text-base text-slate-400">dns</span>
                        <span class="truncate"><%= typeof bot.server !== 'undefined' ? bot.server.ip + ':' + bot.server.port : 'No server configured' %></span>
                    </p>
                    <p class="flex items-center gap-2.5">
                        <span class="material-icons text-base text-slate-400">person</span>
                        <span class="truncate"><%= bot.username || 'Not connected' %></span>
                    </p>
                </div>
                <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-700/30 flex justify-between items-center text-xs text-slate-400 dark:text-slate-500">
                    <span>ID: #<%= bot.id %></span>
                    <span><%= typeof bot.server !== 'undefined' ? bot.server.version : 'Unknown' %></span>
                </div>
            </div>
        <% }); %>

        <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
        <!-- Add New Placeholder -->
        <div onclick="openCreateModal()" class="bg-slate-50 dark:bg-slate-800/30 border-2 border-dashed border-slate-200 dark:border-slate-700/50 rounded-xl p-5 flex flex-col items-center justify-center text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 cursor-pointer transition-all">
            <span class="material-icons text-2xl mb-2">add_circle_outline</span>
            <span class="font-medium text-sm">Add New Bot</span>
        </div>
        <% } %>
    </div>
</main>

<!-- Create Bot Modal -->
<div id="create-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white dark:bg-slate-800/90 backdrop-blur-md p-6 rounded-xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-300 border border-slate-200 dark:border-slate-700/50 shadow-xl" id="create-modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Create New Bot</h3>
            <button onclick="closeCreateModal()" class="p-1.5 rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <span class="material-icons text-base">close</span>
            </button>
        </div>
        <form onsubmit="createBot(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Bot Name</label>
                <input type="text" name="name" placeholder="e.g. Survival Server" required class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2.5 focus:ring-1 focus:ring-slate-400 outline-none transition-all text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Microsoft Account Email</label>
                <input type="email" name="email" placeholder="user@example.com" required class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2.5 focus:ring-1 focus:ring-slate-400 outline-none transition-all text-sm">
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="col-span-2">
                    <label class="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Server IP</label>
                    <input type="text" name="ip" placeholder="play.example.com" required class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2.5 focus:ring-1 focus:ring-slate-400 outline-none transition-all text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Port</label>
                    <input type="number" name="port" value="25565" required class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2.5 focus:ring-1 focus:ring-slate-400 outline-none transition-all text-sm">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Minecraft Version</label>
                <select name="version" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2.5 focus:ring-1 focus:ring-slate-400 outline-none transition-all text-sm">
                    <option value="1.20.4">1.20.4</option>
                    <option value="1.20.1">1.20.1</option>
                    <option value="1.19.4">1.19.4</option>
                    <option value="1.18.2">1.18.2</option>
                    <option value="1.12.2">1.12.2</option>
                    <option value="auto">Auto</option>
                </select>
            </div>
            <div class="flex justify-end gap-2.5 mt-6 pt-4 border-t border-slate-100 dark:border-slate-700/50">
                <button type="button" onclick="closeCreateModal()" class="px-4 py-2 text-slate-600 hover:text-slate-800 dark:hover:text-slate-200 font-medium text-sm">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white rounded-lg font-medium text-sm border border-slate-200 dark:border-slate-700 shadow-sm">Create</button>
            </div>
        </form>
    </div>
</div>

<script>
function openCreateModal() {
    // Check if user is admin before opening modal
    <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
        const modal = document.getElementById('create-modal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            document.getElementById('create-modal-content').classList.remove('scale-95');
        }, 10);
    <% } else { %>
        alert('Permission denied. Only administrators can create bots.');
    <% } %>
}

function closeCreateModal() {
    const modal = document.getElementById('create-modal');
    modal.classList.add('opacity-0');
    document.getElementById('create-modal-content').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

async function createBot(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        const res = await fetch('/api/bots/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            window.location.reload();
        } else {
            const errorData = await res.json();
            alert(errorData.error || 'Failed to create bot');
        }
    } catch (err) {
        console.error(err);
        alert('Error creating bot');
    }
}
</script>

<%- include('partials/footer') %>
